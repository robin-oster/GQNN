if(Array.prototype.find||(Array.prototype.find=function(b){if(this===null)throw new TypeError("Array.prototype.find called on null or undefined");if(typeof b!="function")throw new TypeError("predicate must be a function");for(var t=Object(this),e=t.length>>>0,i=arguments[1],n,r=0;r<e;r++)if(n=t[r],b.call(i,n,r,t))return n}),window&&typeof window.CustomEvent!="function"){let b=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i};typeof window.Event<"u"&&(b.prototype=window.Event.prototype),window.CustomEvent=b}class C{constructor(t){this.tribute=t,this.tribute.events=this}static keys(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}bind(t){t.boundKeydown=this.keydown.bind(t,this),t.boundKeyup=this.keyup.bind(t,this),t.boundInput=this.input.bind(t,this),t.addEventListener("keydown",t.boundKeydown,!1),t.addEventListener("keyup",t.boundKeyup,!1),t.addEventListener("input",t.boundInput,!1)}unbind(t){t.removeEventListener("keydown",t.boundKeydown,!1),t.removeEventListener("keyup",t.boundKeyup,!1),t.removeEventListener("input",t.boundInput,!1),delete t.boundKeydown,delete t.boundKeyup,delete t.boundInput}keydown(t,e){t.shouldDeactivate(e)&&(t.tribute.isActive=!1,t.tribute.hideMenu());let i=this;t.commandEvent=!1,C.keys().forEach(n=>{n.key===e.keyCode&&(t.commandEvent=!0,t.callbacks()[n.value.toLowerCase()](e,i))})}input(t,e){t.inputEvent=!0,t.keyup.call(this,t,e)}click(t,e){let i=t.tribute;if(i.menu&&i.menu.contains(e.target)){let n=e.target;for(e.preventDefault(),e.stopPropagation();n.nodeName.toLowerCase()!=="li";)if(n=n.parentNode,!n||n===i.menu)throw new Error("cannot find the <li> container for the click");i.selectItemAtIndex(n.getAttribute("data-index"),e),i.hideMenu()}else i.current.element&&!i.current.externalTrigger&&(i.current.externalTrigger=!1,setTimeout(()=>i.hideMenu()))}keyup(t,e){if(t.inputEvent&&(t.inputEvent=!1),t.updateSelection(this),e.keyCode!==27){if(!t.tribute.allowSpaces&&t.tribute.hasTrailingSpace){t.tribute.hasTrailingSpace=!1,t.commandEvent=!0,t.callbacks().space(e,this);return}if(!t.tribute.isActive)if(t.tribute.autocompleteMode)t.callbacks().triggerChar(e,this,"");else{let i=t.getKeyCode(t,this,e);if(isNaN(i)||!i)return;let n=t.tribute.triggers().find(r=>r.charCodeAt(0)===i);typeof n<"u"&&t.callbacks().triggerChar(e,this,n)}t.tribute.current.mentionText.length<t.tribute.current.collection.menuShowMinLength||((t.tribute.current.trigger||t.tribute.autocompleteMode)&&t.commandEvent===!1||t.tribute.isActive&&e.keyCode===8)&&t.tribute.showMenuFor(this,!0)}}shouldDeactivate(t){if(!this.tribute.isActive)return!1;if(this.tribute.current.mentionText.length===0){let e=!1;return C.keys().forEach(i=>{t.keyCode===i.key&&(e=!0)}),!e}return!1}getKeyCode(t,e,i){let n=t.tribute,r=n.range.getTriggerInfo(!1,n.hasTrailingSpace,!0,n.allowSpaces,n.autocompleteMode);return r?r.mentionTriggerChar.charCodeAt(0):!1}updateSelection(t){this.tribute.current.element=t;let e=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);e&&(this.tribute.current.selectedPath=e.mentionSelectedPath,this.tribute.current.mentionText=e.mentionText,this.tribute.current.selectedOffset=e.mentionSelectedOffset)}callbacks(){return{triggerChar:(t,e,i)=>{let n=this.tribute;n.current.trigger=i;let r=n.collection.find(o=>o.trigger===i);n.current.collection=r,n.current.mentionText.length>=n.current.collection.menuShowMinLength&&n.inputEvent&&n.showMenuFor(e,!0)},enter:(t,e)=>{this.tribute.isActive&&this.tribute.current.filteredItems&&(t.preventDefault(),t.stopPropagation(),setTimeout(()=>{this.tribute.selectItemAtIndex(this.tribute.menuSelected,t),this.tribute.hideMenu()},0))},escape:(t,e)=>{this.tribute.isActive&&(t.preventDefault(),t.stopPropagation(),this.tribute.isActive=!1,this.tribute.hideMenu())},tab:(t,e)=>{this.callbacks().enter(t,e)},space:(t,e)=>{this.tribute.isActive&&(this.tribute.spaceSelectsMatch?this.callbacks().enter(t,e):this.tribute.allowSpaces||(t.stopPropagation(),setTimeout(()=>{this.tribute.hideMenu(),this.tribute.isActive=!1},0)))},up:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopPropagation();let i=this.tribute.current.filteredItems.length,n=this.tribute.menuSelected;i>n&&n>0?(this.tribute.menuSelected--,this.setActiveLi()):n===0&&(this.tribute.menuSelected=i-1,this.setActiveLi(),this.tribute.menu.scrollTop=this.tribute.menu.scrollHeight)}},down:(t,e)=>{if(this.tribute.isActive&&this.tribute.current.filteredItems){t.preventDefault(),t.stopPropagation();let i=this.tribute.current.filteredItems.length-1,n=this.tribute.menuSelected;i>n?(this.tribute.menuSelected++,this.setActiveLi()):i===n&&(this.tribute.menuSelected=0,this.setActiveLi(),this.tribute.menu.scrollTop=0)}},delete:(t,e)=>{this.tribute.isActive&&this.tribute.current.mentionText.length<1?this.tribute.hideMenu():this.tribute.isActive&&this.tribute.showMenuFor(e)}}}setActiveLi(t){let e=this.tribute.menu.querySelectorAll("li"),i=e.length>>>0;t&&(this.tribute.menuSelected=parseInt(t));for(let n=0;n<i;n++){let r=e[n];if(n===this.tribute.menuSelected){r.classList.add(this.tribute.current.collection.selectClass);let o=r.getBoundingClientRect(),s=this.tribute.menu.getBoundingClientRect();if(o.bottom>s.bottom){let l=o.bottom-s.bottom;this.tribute.menu.scrollTop+=l}else if(o.top<s.top){let l=s.top-o.top;this.tribute.menu.scrollTop-=l}}else r.classList.remove(this.tribute.current.collection.selectClass)}}getFullHeight(t,e){let i=t.getBoundingClientRect().height;if(e){let n=t.currentStyle||window.getComputedStyle(t);return i+parseFloat(n.marginTop)+parseFloat(n.marginBottom)}return i}}class I{constructor(t){this.tribute=t,this.tribute.menuEvents=this,this.menu=this.tribute.menu}bind(t){this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce(()=>{this.tribute.isActive&&this.tribute.hideMenu()},10,!1),this.windowResizeEvent=this.debounce(()=>{this.tribute.isActive&&this.tribute.hideMenu()},10,!1),this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}unbind(t){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}debounce(t,e,i){var n;return()=>{var r=this,o=arguments,s=()=>{n=null,i||t.apply(r,o)},l=i&&!n;clearTimeout(n),n=setTimeout(s,e),l&&t.apply(r,o)}}}class k{constructor(t){this.tribute=t,this.tribute.range=this}getDocument(){let t;return this.tribute.current.collection&&(t=this.tribute.current.collection.iframe),t?t.contentWindow.document:document}positionMenuAtCaret(t){let e=this.tribute.current,i,n=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(typeof n<"u"){if(!this.tribute.positionMenu){this.tribute.menu.style.cssText="display: block;";return}this.isContentEditable(e.element)?i=this.getContentEditableCaretPosition(n.mentionPosition):i=this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,n.mentionPosition),this.tribute.menu.style.cssText=`top: ${i.top}px;
                                     left: ${i.left}px;
                                     right: ${i.right}px;
                                     bottom: ${i.bottom}px;
                                     max-height: ${i.maxHeight||500}px;
                                     max-width: ${i.maxWidth||300}px;
                                     position: ${i.position||"absolute"};
                                     display: block;`,i.left==="auto"&&(this.tribute.menu.style.left="auto"),i.top==="auto"&&(this.tribute.menu.style.top="auto"),t&&this.scrollIntoView()}else this.tribute.menu.style.cssText="display: none"}get menuContainerIsBody(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}selectElement(t,e,i){let n,r=t;if(e)for(var o=0;o<e.length;o++){if(r=r.childNodes[e[o]],r===void 0)return;for(;r.length<i;)i-=r.length,r=r.nextSibling;r.childNodes.length===0&&!r.length&&(r=r.previousSibling)}let s=this.getWindowSelection();n=this.getDocument().createRange(),n.setStart(r,i),n.setEnd(r,i),n.collapse(!0);try{s.removeAllRanges()}catch{}s.addRange(n),t.focus()}replaceTriggerText(t,e,i,n,r){let o=this.getTriggerInfo(!0,i,e,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(o!==void 0){let s=this.tribute.current,l=new CustomEvent("tribute-replaced",{detail:{item:r,instance:s,context:o,event:n}});if(this.isContentEditable(s.element)){let u=typeof this.tribute.replaceTextSuffix=="string"?this.tribute.replaceTextSuffix:"\xA0";t+=u;let a=o.mentionPosition+o.mentionText.length;this.tribute.autocompleteMode||(a+=o.mentionTriggerChar.length),this.pasteHtml(t,o.mentionPosition,a)}else{let u=this.tribute.current.element,a=typeof this.tribute.replaceTextSuffix=="string"?this.tribute.replaceTextSuffix:" ";t+=a;let d=o.mentionPosition,c=o.mentionPosition+o.mentionText.length+a.length;this.tribute.autocompleteMode||(c+=o.mentionTriggerChar.length-1),u.value=u.value.substring(0,d)+t+u.value.substring(c,u.value.length),u.selectionStart=d+t.length,u.selectionEnd=d+t.length}s.element.dispatchEvent(new CustomEvent("input",{bubbles:!0})),s.element.dispatchEvent(l)}}pasteHtml(t,e,i){let n,r;r=this.getWindowSelection(),n=this.getDocument().createRange(),n.setStart(r.anchorNode,e),n.setEnd(r.anchorNode,i),n.deleteContents();let o=this.getDocument().createElement("div");o.innerHTML=t;let s=this.getDocument().createDocumentFragment(),l,u;for(;l=o.firstChild;)u=s.appendChild(l);n.insertNode(s),u&&(n=n.cloneRange(),n.setStartAfter(u),n.collapse(!0),r.removeAllRanges(),r.addRange(n))}getWindowSelection(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}getNodePositionInParent(t){if(t.parentNode===null)return 0;for(var e=0;e<t.parentNode.childNodes.length;e++)if(t.parentNode.childNodes[e]===t)return e}getContentEditableSelectedPath(t){let e=this.getWindowSelection(),i=e.anchorNode,n=[],r;if(i!=null){let o,s=i.contentEditable;for(;i!==null&&s!=="true";)o=this.getNodePositionInParent(i),n.push(o),i=i.parentNode,i!==null&&(s=i.contentEditable);return n.reverse(),r=e.getRangeAt(0).startOffset,{selected:i,path:n,offset:r}}}getTextPrecedingCurrentSelection(){let t=this.tribute.current,e="";if(this.isContentEditable(t.element)){let i=this.getWindowSelection().anchorNode;if(i!=null){let n=i.textContent,r=this.getWindowSelection().getRangeAt(0).startOffset;n&&r>=0&&(e=n.substring(0,r))}}else{let i=this.tribute.current.element;if(i){let n=i.selectionStart;i.value&&n>=0&&(e=i.value.substring(0,n))}}return e}getLastWordInText(t){t=t.replace(/\u00A0/g," ");var e;this.tribute.autocompleteSeparator?e=t.split(this.tribute.autocompleteSeparator):e=t.split(/\s+/);var i=e.length-1;return e[i].trim()}getTriggerInfo(t,e,i,n,r){let o=this.tribute.current,s,l,u;if(!this.isContentEditable(o.element))s=this.tribute.current.element;else{let c=this.getContentEditableSelectedPath(o);c&&(s=c.selected,l=c.path,u=c.offset)}let a=this.getTextPrecedingCurrentSelection(),d=this.getLastWordInText(a);if(r)return{mentionPosition:a.length-d.length,mentionText:d,mentionSelectedElement:s,mentionSelectedPath:l,mentionSelectedOffset:u};if(a!=null){let c=-1,p;if(this.tribute.collection.forEach(m=>{let f=m.trigger,g=m.requireLeadingSpace?this.lastIndexWithLeadingSpace(a,f):a.lastIndexOf(f);g>c&&(c=g,p=f,i=m.requireLeadingSpace)}),c>=0&&(c===0||!i||/[\xA0\s]/g.test(a.substring(c-1,c)))){let m=a.substring(c+p.length,a.length);p=a.substring(c,c+p.length);let f=m.substring(0,1),g=m.length>0&&(f===" "||f==="\xA0");e&&(m=m.trim());let T=n?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=T.test(m),!g&&(t||!T.test(m)))return{mentionPosition:c,mentionText:m,mentionSelectedElement:s,mentionSelectedPath:l,mentionSelectedOffset:u,mentionTriggerChar:p}}}}lastIndexWithLeadingSpace(t,e){let i=t.split("").reverse().join(""),n=-1;for(let r=0,o=t.length;r<o;r++){let s=r===t.length-1,l=/\s/.test(i[r+1]),u=!0;for(let a=e.length-1;a>=0;a--)if(e[a]!==i[r-a]){u=!1;break}if(u&&(s||l)){n=t.length-1-r;break}}return n}isContentEditable(t){return t.nodeName!=="INPUT"&&t.nodeName!=="TEXTAREA"}isMenuOffScreen(t,e){let i=window.innerWidth,n=window.innerHeight,r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),s=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l=typeof t.top=="number"?t.top:s+n-t.bottom-e.height,u=typeof t.right=="number"?t.right:t.left+e.width,a=typeof t.bottom=="number"?t.bottom:t.top+e.height,d=typeof t.left=="number"?t.left:o+i-t.right-e.width;return{top:l<Math.floor(s),right:u>Math.ceil(o+i),bottom:a>Math.ceil(s+n),left:d<Math.floor(o)}}getMenuDimensions(){let t={width:null,height:null};return this.tribute.menu.style.cssText=`top: 0px;
                                 left: 0px;
                                 position: fixed;
                                 display: block;
                                 visibility; hidden;
                                 max-height:500px;`,t.width=this.tribute.menu.offsetWidth,t.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",t}getTextAreaOrInputUnderlinePosition(t,e,i){let n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],r=this.getDocument().createElement("div");r.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(r);let o=r.style,s=window.getComputedStyle?getComputedStyle(t):t.currentStyle;o.whiteSpace="pre-wrap",t.nodeName!=="INPUT"&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",n.forEach(p=>{o[p]=s[p]});let l=document.createElement("span");l.textContent=t.value.substring(0,e),r.appendChild(l),t.nodeName==="INPUT"&&(r.textContent=r.textContent.replace(/\s/g,"\xA0"));let u=this.getDocument().createElement("span");u.textContent="&#x200B;",r.appendChild(u);let a=this.getDocument().createElement("span");a.textContent=t.value.substring(e),r.appendChild(a);let d=t.getBoundingClientRect();r.style.position="fixed",r.style.left=d.left+"px",r.style.top=d.top+"px",r.style.width=d.width+"px",r.style.height=d.height+"px",r.scrollTop=t.scrollTop;var c=u.getBoundingClientRect();return this.getDocument().body.removeChild(r),this.getFixedCoordinatesRelativeToRect(c)}getContentEditableCaretPosition(t){let e,i=this.getWindowSelection();e=this.getDocument().createRange(),e.setStart(i.anchorNode,t),e.setEnd(i.anchorNode,t),e.collapse(!1);let n=e.getBoundingClientRect();return this.getFixedCoordinatesRelativeToRect(n)}getFixedCoordinatesRelativeToRect(t){let e={position:"fixed",left:t.left,top:t.top+t.height},i=this.getMenuDimensions();var n=t.top,r=window.innerHeight-(t.top+t.height);r<i.height&&(n>=i.height||n>r?(e.top="auto",e.bottom=window.innerHeight-t.top,r<i.height&&(e.maxHeight=n)):n<i.height&&(e.maxHeight=r));var o=t.left,s=window.innerWidth-t.left;return s<i.width&&(o>=i.width||o>s?(e.left="auto",e.right=window.innerWidth-t.left,s<i.width&&(e.maxWidth=o)):o<i.width&&(e.maxWidth=s)),e}scrollIntoView(t){let e=20,i,n=100,r=this.menu;if(typeof r>"u")return;for(;i===void 0||i.height===0;)if(i=r.getBoundingClientRect(),i.height===0&&(r=r.childNodes[0],r===void 0||!r.getBoundingClientRect))return;let o=i.top,s=o+i.height;if(o<0)window.scrollTo(0,window.pageYOffset+i.top-e);else if(s>window.innerHeight){let l=window.pageYOffset+i.top-e;l-window.pageYOffset>n&&(l=window.pageYOffset+n);let u=window.pageYOffset-(window.innerHeight-s);u>l&&(u=l),window.scrollTo(0,u)}}}class N{constructor(t){this.tribute=t,this.tribute.search=this}simpleFilter(t,e){return e.filter(i=>this.test(t,i))}test(t,e){return this.match(t,e)!==null}match(t,e,i){i=i||{},e.length;let n=i.pre||"",r=i.post||"",o=i.caseSensitive&&e||e.toLowerCase();if(i.skip)return{rendered:e,score:0};t=i.caseSensitive&&t||t.toLowerCase();let s=this.traverse(o,t,0,0,[]);return s?{rendered:this.render(e,s.cache,n,r),score:s.score}:null}traverse(t,e,i,n,r){if(this.tribute.autocompleteSeparator&&(e=e.split(this.tribute.autocompleteSeparator).splice(-1)[0]),e.length===n)return{score:this.calculateScore(r),cache:r.slice()};if(t.length===i||e.length-n>t.length-i)return;let o=e[n],s=t.indexOf(o,i),l,u;for(;s>-1;){if(r.push(s),u=this.traverse(t,e,s+1,n+1,r),r.pop(),!u)return l;(!l||l.score<u.score)&&(l=u),s=t.indexOf(o,s+1)}return l}calculateScore(t){let e=0,i=1;return t.forEach((n,r)=>{r>0&&(t[r-1]+1===n?i+=i+1:i=1),e+=i}),e}render(t,e,i,n){var r=t.substring(0,e[0]);return e.forEach((o,s)=>{r+=i+t[o]+n+t.substring(o+1,e[s+1]?e[s+1]:t.length)}),r}filter(t,e,i){return i=i||{},e.reduce((n,r,o,s)=>{let l=r;i.extract&&(l=i.extract(r),l||(l=""));let u=this.match(t,l,i);return u!=null&&(n[n.length]={string:u.rendered,score:u.score,index:o,original:r}),n},[]).sort((n,r)=>r.score-n.score||n.index-r.index)}}class v{constructor({values:t=null,loadingItemTemplate:e=null,iframe:i=null,selectClass:n="highlight",containerClass:r="tribute-container",itemClass:o="",trigger:s="@",autocompleteMode:l=!1,autocompleteSeparator:u=null,selectTemplate:a=null,menuItemTemplate:d=null,lookup:c="key",fillAttr:p="value",collection:m=null,menuContainer:f=null,noMatchTemplate:g=null,requireLeadingSpace:T=!0,allowSpaces:S=!1,replaceTextSuffix:M=null,positionMenu:A=!0,spaceSelectsMatch:L=!1,searchOpts:y={},menuItemLimit:E=null,menuShowMinLength:x=0}){if(this.autocompleteMode=l,this.autocompleteSeparator=u,this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=f,this.allowSpaces=S,this.replaceTextSuffix=M,this.positionMenu=A,this.hasTrailingSpace=!1,this.spaceSelectsMatch=L,this.autocompleteMode&&(s="",S=!1),t)this.collection=[{trigger:s,iframe:i,selectClass:n,containerClass:r,itemClass:o,selectTemplate:(a||v.defaultSelectTemplate).bind(this),menuItemTemplate:(d||v.defaultMenuItemTemplate).bind(this),noMatchTemplate:(h=>typeof h=="string"?h.trim()===""?null:h:typeof h=="function"?h.bind(this):g||(function(){return"<li>No Match Found!</li>"}).bind(this))(g),lookup:c,fillAttr:p,values:t,loadingItemTemplate:e,requireLeadingSpace:T,searchOpts:y,menuItemLimit:E,menuShowMinLength:x}];else if(m)this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=m.map(h=>({trigger:h.trigger||s,iframe:h.iframe||i,selectClass:h.selectClass||n,containerClass:h.containerClass||r,itemClass:h.itemClass||o,selectTemplate:(h.selectTemplate||v.defaultSelectTemplate).bind(this),menuItemTemplate:(h.menuItemTemplate||v.defaultMenuItemTemplate).bind(this),noMatchTemplate:(w=>typeof w=="string"?w.trim()===""?null:w:typeof w=="function"?w.bind(this):g||(function(){return"<li>No Match Found!</li>"}).bind(this))(g),lookup:h.lookup||c,fillAttr:h.fillAttr||p,values:h.values,loadingItemTemplate:h.loadingItemTemplate,requireLeadingSpace:h.requireLeadingSpace,searchOpts:h.searchOpts||y,menuItemLimit:h.menuItemLimit||E,menuShowMinLength:h.menuShowMinLength||x}));else throw new Error("[Tribute] No collection specified.");new k(this),new C(this),new I(this),new N(this)}get isActive(){return this._isActive}set isActive(t){if(this._isActive!=t&&(this._isActive=t,this.current.element)){let e=new CustomEvent(`tribute-active-${t}`);this.current.element.dispatchEvent(e)}}static defaultSelectTemplate(t){return typeof t>"u"?`${this.current.collection.trigger}${this.current.mentionText}`:this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+t.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+t.original[this.current.collection.fillAttr]}static defaultMenuItemTemplate(t){return t.string}static inputTypes(){return["TEXTAREA","INPUT"]}triggers(){return this.collection.map(t=>t.trigger)}attach(t){if(!t)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if(typeof jQuery<"u"&&t instanceof jQuery&&(t=t.get()),t.constructor===NodeList||t.constructor===HTMLCollection||t.constructor===Array){let i=t.length;for(var e=0;e<i;++e)this._attach(t[e])}else this._attach(t)}_attach(t){t.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+t.nodeName),this.ensureEditable(t),this.events.bind(t),t.setAttribute("data-tribute",!0)}ensureEditable(t){if(v.inputTypes().indexOf(t.nodeName)===-1)if(t.contentEditable)t.contentEditable=!0;else throw new Error("[Tribute] Cannot bind to "+t.nodeName)}createMenu(t){let e=this.range.getDocument().createElement("div"),i=this.range.getDocument().createElement("ul");return e.className=t,e.appendChild(i),this.menuContainer?this.menuContainer.appendChild(e):this.range.getDocument().body.appendChild(e)}showMenuFor(t,e){if(this.isActive&&this.current.element===t&&this.current.mentionText===this.currentMentionTextSnapshot)return;this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass),t.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText="");const i=n=>{if(!this.isActive)return;let r=this.search.filter(this.current.mentionText,n,{pre:this.current.collection.searchOpts.pre||"<span>",post:this.current.collection.searchOpts.post||"</span>",skip:this.current.collection.searchOpts.skip,extract:l=>{if(typeof this.current.collection.lookup=="string")return l[this.current.collection.lookup];if(typeof this.current.collection.lookup=="function")return this.current.collection.lookup(l,this.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});this.current.collection.menuItemLimit&&(r=r.slice(0,this.current.collection.menuItemLimit)),this.current.filteredItems=r;let o=this.menu.querySelector("ul");if(!r.length){let l=new CustomEvent("tribute-no-match",{detail:this.menu});this.current.element.dispatchEvent(l),typeof this.current.collection.noMatchTemplate=="function"&&!this.current.collection.noMatchTemplate()||!this.current.collection.noMatchTemplate?this.hideMenu():(typeof this.current.collection.noMatchTemplate=="function"?o.innerHTML=this.current.collection.noMatchTemplate():o.innerHTML=this.current.collection.noMatchTemplate,this.range.positionMenuAtCaret(e));return}o.innerHTML="";let s=this.range.getDocument().createDocumentFragment();r.forEach((l,u)=>{let a=this.range.getDocument().createElement("li");a.setAttribute("data-index",u),a.className=this.current.collection.itemClass,a.addEventListener("mousemove",d=>{let[c,p]=this._findLiTarget(d.target);d.movementY!==0&&this.events.setActiveLi(p)}),this.menuSelected===u&&a.classList.add(this.current.collection.selectClass),a.innerHTML=this.current.collection.menuItemTemplate(l),s.appendChild(a)}),o.appendChild(s),this.range.positionMenuAtCaret(e)};typeof this.current.collection.values=="function"?(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(e)),this.current.collection.values(this.current.mentionText,i)):i(this.current.collection.values)}_findLiTarget(t){if(!t)return[];const e=t.getAttribute("data-index");return e?[t,e]:this._findLiTarget(t.parentNode)}showMenuForCollection(t,e){t!==document.activeElement&&this.placeCaretAtEnd(t),this.current.collection=this.collection[e||0],this.current.externalTrigger=!0,this.current.element=t,t.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(t,this.current.collection.trigger),this.showMenuFor(t)}placeCaretAtEnd(t){if(t.focus(),typeof window.getSelection<"u"&&typeof document.createRange<"u"){var e=document.createRange();e.selectNodeContents(t),e.collapse(!1);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)}else if(typeof document.body.createTextRange<"u"){var n=document.body.createTextRange();n.moveToElementText(t),n.collapse(!1),n.select()}}insertTextAtCursor(t){var e,i;e=window.getSelection(),i=e.getRangeAt(0),i.deleteContents();var n=document.createTextNode(t);i.insertNode(n),i.selectNodeContents(n),i.collapse(!1),e.removeAllRanges(),e.addRange(i)}insertAtCaret(t,e){var i=t.scrollTop,n=t.selectionStart,r=t.value.substring(0,n),o=t.value.substring(t.selectionEnd,t.value.length);t.value=r+e+o,n=n+e.length,t.selectionStart=n,t.selectionEnd=n,t.focus(),t.scrollTop=i}hideMenu(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}selectItemAtIndex(t,e){if(t=parseInt(t),typeof t!="number"||isNaN(t))return;let i=this.current.filteredItems[t],n=this.current.collection.selectTemplate(i);n!==null&&this.replaceText(n,e,i)}replaceText(t,e,i){this.range.replaceTriggerText(t,!0,!0,e,i)}_append(t,e,i){if(typeof t.values=="function")throw new Error("Unable to append to values, as it is a function.");i?t.values=e:t.values=t.values.concat(e)}append(t,e,i){let n=parseInt(t);if(typeof n!="number")throw new Error("please provide an index for the collection to update.");let r=this.collection[n];this._append(r,e,i)}appendCurrent(t,e){if(this.isActive)this._append(this.current.collection,t,e);else throw new Error("No active state. Please use append instead and pass an index.")}detach(t){if(!t)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if(typeof jQuery<"u"&&t instanceof jQuery&&(t=t.get()),t.constructor===NodeList||t.constructor===HTMLCollection||t.constructor===Array){let i=t.length;for(var e=0;e<i;++e)this._detach(t[e])}else this._detach(t)}_detach(t){this.events.unbind(t),t.tributeMenu&&this.menuEvents.unbind(t.tributeMenu),setTimeout(()=>{t.removeAttribute("data-tribute"),this.isActive=!1,t.tributeMenu&&t.tributeMenu.remove()})}}export{v as T};
